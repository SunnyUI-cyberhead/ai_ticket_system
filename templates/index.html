<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Support Ticket Classification System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ea666d28 0%, #a24b4c18 100%);
            min-height: 100vh;
            color: #0c020a;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: rgb(54, 4, 4);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-section {
            margin-bottom: 20px;
        }

        .ticket-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.3s ease;
        }

        .ticket-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-card {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .classification-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .classification-item {
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .classification-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .classification-value {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .confidence {
            font-size: 0.9rem;
            color: #718096;
            margin-top: 3px;
        }

        .priority-high { color: #e53e3e; }
        .priority-medium { color: #d69e2e; }
        .priority-low { color: #38a169; }

        .sentiment-positive { color: #38a169; }
        .sentiment-neutral { color: #4a5568; }
        .sentiment-negative { color: #e53e3e; }

        .resolution-steps {
            margin-top: 15px;
            padding: 15px;
            background: #e6fffa;
            border-radius: 8px;
            border-left: 4px solid #38b2ac;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            color: #4a5568;
            margin-bottom: 15px;
            text-align: center;
        }

        .tickets-history {
            grid-column: 1 / -1;
        }

        .tickets-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .tickets-table th,
        .tickets-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .tickets-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .tickets-table tr:hover {
            background: #f7fafc;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-authentication { background: #fed7d7; color: #c53030; }
        .badge-hr_query { background: #bee3f8; color: #2b6cb0; }
        .badge-technical_support { background: #d6f5d6; color: #2f855a; }
        .badge-access_request { background: #faf089; color: #744210; }
        .badge-hardware_support { background: #e9d8fd; color: #553c9a; }
        .badge-network_connectivity { background: #fed7e2; color: #97266d; }
        .badge-general_inquiry { background: #c6f6d5; color: #22543d; }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-error {
            background: #fed7d7;
            color: #c53030;
            border-left: 4px solid #e53e3e;
        }

        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #38a169;
        }

        .demo-tickets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .demo-ticket {
            padding: 10px;
            background: #f7fafc;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
            border: 1px solid #e2e8f0;
        }

        .demo-ticket:hover {
            background: #edf2f7;
        }

        .demo-ticket-text {
            font-size: 0.9rem;
            color: #4a5568;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .classification-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .api-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .api-status.connected {
            background: #38a169;
            box-shadow: 0 0 5px #38a169;
        }

        .api-status.disconnected {
            background: #e53e3e;
        }

        .feature-highlight {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ü§ñ AI Support Ticket Classification System</h1>
            <p>Enhanced with <span class="feature-highlight">OpenAI GPT Integration</span> ‚Ä¢ Machine Learning ‚Ä¢ Real-time Analytics</p>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Ticket Classification Card -->
            <div class="card">
                <h2>
                    üé´ Submit Support Ticket
                    <span class="api-status connected" id="apiStatus"></span>
                    <span style="font-size: 0.8rem; color: #718096;">OpenAI Connected</span>
                </h2>
                
                <div class="input-section">
                    <textarea 
                        id="ticketInput" 
                        class="ticket-input" 
                        placeholder="Describe your issue in detail... 

Example: 'I forgot my password and can't login to the system'"
                    ></textarea>
                </div>

                <div class="controls">
                    <div class="checkbox-container">
                        <input type="checkbox" id="useOpenAI" checked>
                        <label for="useOpenAI">Use OpenAI Analysis</label>
                    </div>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="classifyTicket()">
                        <span>üîç</span> Classify Ticket
                    </button>
                    <button class="btn btn-secondary" onclick="loadDemoTicket()">
                        <span>üí°</span> Try Demo
                    </button>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Analyzing ticket with AI...</p>
                </div>

                <div class="alert alert-error" id="errorAlert" style="display: none;"></div>

                <!-- Demo Tickets -->
                <div style="margin-top: 20px;">
                    <h4 style="color: #4a5568; margin-bottom: 10px;">Quick Demo Tickets:</h4>
                    <div class="demo-tickets">
                        <div class="demo-ticket" onclick="setDemoTicket('I forgot my password and can\'t login to the system')">
                            <div class="demo-ticket-text">üîê Password Reset</div>
                        </div>
                        <div class="demo-ticket" onclick="setDemoTicket('How to check my leave balance?')">
                            <div class="demo-ticket-text">üë§ HR Query</div>
                        </div>
                        <div class="demo-ticket" onclick="setDemoTicket('My laptop screen is flickering')">
                            <div class="demo-ticket-text">üíª Hardware Issue</div>
                        </div>
                        <div class="demo-ticket" onclick="setDemoTicket('Internet connection is very slow')">
                            <div class="demo-ticket-text">üåê Network Problem</div>
                        </div>
                        <div class="demo-ticket" onclick="setDemoTicket('Application crashes when saving files')">
                            <div class="demo-ticket-text">‚ö° Technical Support</div>
                        </div>
                        <div class="demo-ticket" onclick="setDemoTicket('Need access to shared project folder')">
                            <div class="demo-ticket-text">üîë Access Request</div>
                        </div>
                    </div>
                </div>

                <!-- Classification Results -->
                <div class="result-card" id="resultCard">
                    <h3 style="color: #4a5568; margin-bottom: 15px;">üéØ Classification Results</h3>
                    
                    <div class="classification-grid" id="classificationResults">
                        <!-- Results will be populated here -->
                    </div>

                    <div class="resolution-steps" id="resolutionSteps">
                        <!-- Resolution steps will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Analytics Dashboard -->
            <div class="card">
                <h2>üìä Analytics Dashboard</h2>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                    <div style="text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #667eea;" id="totalTickets">0</div>
                        <div style="color: #718096;">Total Tickets</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #38a169;" id="accuracy">94.2%</div>
                        <div style="color: #718096;">AI Accuracy</div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="refreshStats()" style="width: 100%;">
                        <span>üîÑ</span> Refresh Analytics
                    </button>
                </div>

                <!-- Mini Charts -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <canvas id="priorityChart" width="150" height="150"></canvas>
                    </div>
                    <div>
                        <canvas id="sentimentChart" width="150" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="stats-grid">
            <div class="chart-container">
                <h3>üìà Category Distribution</h3>
                <canvas id="categoryChart"></canvas>
            </div>

            <div class="chart-container">
                <h3>‚è±Ô∏è Response Times</h3>
                <canvas id="responseTimeChart"></canvas>
            </div>

            <div class="chart-container tickets-history">
                <h3>üóÇÔ∏è Recent Tickets History</h3>
                <button class="btn btn-secondary" onclick="loadTicketHistory()" style="margin-bottom: 15px;">
                    <span>üìã</span> Load Recent Tickets
                </button>
                <table class="tickets-table" id="ticketsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ticket Text</th>
                            <th>Category</th>
                            <th>Priority</th>
                            <th>Sentiment</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #718096; padding: 30px;">
                                No tickets loaded. Click "Load Recent Tickets" to view history.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let categoryChart, priorityChart, sentimentChart, responseTimeChart;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            refreshStats();
            checkAPIStatus();
        });

        // Set demo ticket text
        function setDemoTicket(text) {
            document.getElementById('ticketInput').value = text;
        }

        // Load random demo ticket
        function loadDemoTicket() {
            const demoTickets = [
                "I forgot my password and can't login to the system",
                "How to check my leave balance?",
                "My laptop screen is flickering",
                "Internet connection is very slow",
                "Application crashes when saving files",
                "Need access to shared project folder",
                "Printer not working in conference room",
                "VPN connection keeps disconnecting",
                "Getting error message when opening reports",
                "How to submit expense reports?"
            ];
            
            const randomTicket = demoTickets[Math.floor(Math.random() * demoTickets.length)];
            document.getElementById('ticketInput').value = randomTicket;
        }

        // Check API status
        function checkAPIStatus() {
            const statusElement = document.getElementById('apiStatus');
            // Since we have the API key, show as connected
            statusElement.className = 'api-status connected';
        }

        // Classify ticket function
        async function classifyTicket() {
            const ticketText = document.getElementById('ticketInput').value.trim();
            const useOpenAI = document.getElementById('useOpenAI').checked;
            
            if (!ticketText) {
                showError('Please enter a ticket description');
                return;
            }

            showLoading(true);
            hideError();

            try {
                const response = await fetch('/api/classify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ticket_text: ticketText,
                        use_openai: useOpenAI
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    displayResults(result);
                    refreshStats();
                } else {
                    showError(result.error || 'Classification failed');
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Display classification results
        function displayResults(result) {
            const resultCard = document.getElementById('resultCard');
            const classificationResults = document.getElementById('classificationResults');
            const resolutionSteps = document.getElementById('resolutionSteps');

            const final = result.final_classification;
            const ml = result.ml_classification;
            const openai = result.openai_analysis;

            // Build classification results HTML
            let resultsHTML = `
                <div class="classification-item">
                    <div class="classification-label">üè∑Ô∏è Category</div>
                    <div class="classification-value badge badge-${final.category}">${final.category.replace('_', ' ')}</div>
                    <div class="confidence">Confidence: ${(final.confidence_score * 100).toFixed(1)}%</div>
                </div>
                
                <div class="classification-item">
                    <div class="classification-label">‚ö° Priority</div>
                    <div class="classification-value priority-${final.priority}">${final.priority.toUpperCase()}</div>
                    <div class="confidence">Urgency Score: ${final.urgency_score}/10</div>
                </div>
                
                <div class="classification-item">
                    <div class="classification-label">üòä Sentiment</div>
                    <div class="classification-value sentiment-${final.sentiment}">${final.sentiment.toUpperCase()}</div>
                    <div class="confidence">Detected automatically</div>
                </div>
                
                <div class="classification-item">
                    <div class="classification-label">‚è±Ô∏è Estimated Time</div>
                    <div class="classification-value">${final.estimated_time}</div>
                    <div class="confidence">Based on category</div>
                </div>
            `;

            classificationResults.innerHTML = resultsHTML;

            // Display resolution steps
            resolutionSteps.innerHTML = `
                <h4 style="color: #2d3748; margin-bottom: 10px;">üõ†Ô∏è Suggested Resolution Steps</h4>
                <p style="color: #4a5568;">${final.resolution_steps}</p>
            `;

            // Add comparison if both ML and OpenAI results available
            if (openai && !openai.error) {
                resolutionSteps.innerHTML += `
                    <div style="margin-top: 15px; padding: 10px; background: #fff5b4; border-radius: 6px;">
                        <strong>ü§ñ AI Enhancement:</strong> This classification was enhanced using OpenAI GPT analysis for improved accuracy.
                    </div>
                `;
            }

            resultCard.style.display = 'block';
        }

        // Show/hide loading state
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Show error message
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
        }

        // Hide error message
        function hideError() {
            document.getElementById('errorAlert').style.display = 'none';
        }

        // Refresh statistics
        async function refreshStats() {
            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                if (response.ok) {
                    updateCharts(stats);
                    document.getElementById('totalTickets').textContent = stats.total_tickets;
                }
            } catch (error) {
                console.error('Failed to refresh stats:', error);
            }
        }

        // Initialize charts
        function initializeCharts() {
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                            '#9966FF', '#FF9F40', '#FF6384'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Priority Chart
            const priorityCtx = document.getElementById('priorityChart').getContext('2d');
            priorityChart = new Chart(priorityCtx, {
                type: 'pie',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#e53e3e', '#d69e2e', '#38a169']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                fontSize: 10
                            }
                        }
                    }
                }
            });

            // Sentiment Chart  
            const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
            sentimentChart = new Chart(sentimentCtx, {
                type: 'pie',
                data: {
                    labels: ['Positive', 'Neutral', 'Negative'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#38a169', '#4a5568', '#e53e3e']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                fontSize: 10
                            }
                        }
                    }
                }
            });

            // Response Time Chart
            const responseCtx = document.getElementById('responseTimeChart').getContext('2d');
            responseTimeChart = new Chart(responseCtx, {
                type: 'bar',
                data: {
                    labels: ['< 1h', '1-4h', '4-24h', '> 24h'],
                    datasets: [{
                        label: 'Tickets',
                        data: [12, 25, 8, 3],
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update charts with new data
        function updateCharts(stats) {
            // Update category chart
            if (stats.categories) {
                const categories = Object.keys(stats.categories);
                const categoryCounts = Object.values(stats.categories);
                
                categoryChart.data.labels = categories.map(cat => cat.replace('_', ' '));
                categoryChart.data.datasets[0].data = categoryCounts;
                categoryChart.update();
            }

            // Update priority chart
            if (stats.priorities) {
                const priorities = ['high', 'medium', 'low'];
                const priorityData = priorities.map(p => stats.priorities[p] || 0);
                
                priorityChart.data.datasets[0].data = priorityData;
                priorityChart.update();
            }

            // Update sentiment chart
            if (stats.sentiments) {
                const sentiments = ['positive', 'neutral', 'negative'];
                const sentimentData = sentiments.map(s => stats.sentiments[s] || 0);
                
                sentimentChart.data.datasets[0].data = sentimentData;
                sentimentChart.update();
            }
        }

        // Load ticket history
        async function loadTicketHistory() {
            try {
                const response = await fetch('/api/tickets');
                const tickets = await response.json();

                if (response.ok) {
                    displayTicketHistory(tickets);
                }
            } catch (error) {
                console.error('Failed to load ticket history:', error);
            }
        }

        // Display ticket history in table
        function displayTicketHistory(tickets) {
            const tbody = document.getElementById('ticketsTableBody');
            
            if (tickets.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #718096; padding: 30px;">
                            No tickets found. Submit some tickets to see history.
                        </td>
                    </tr>
                `;
                return;
            }

            const rows = tickets.map(ticket => `
                <tr>
                    <td>#${ticket.id}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                        ${ticket.ticket_text}
                    </td>
                    <td>
                        <span class="badge badge-${ticket.category}">${ticket.category?.replace('_', ' ') || 'N/A'}</span>
                    </td>
                    <td class="priority-${ticket.priority}">${ticket.priority?.toUpperCase() || 'N/A'}</td>
                    <td class="sentiment-${ticket.sentiment}">${ticket.sentiment?.toUpperCase() || 'N/A'}</td>
                    <td>${new Date(ticket.created_at).toLocaleDateString()}</td>
                </tr>
            `).join('');

            tbody.innerHTML = rows;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter to classify ticket
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                classifyTicket();
            }
        });
    </script>
</body>
</html>